<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniStream Player | Design Avançado e WebTorrent</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js"></script>
    
    <style>
        /* =================================================================
           # PALETA DE CORES E VARIÁVEIS
           ================================================================= */
        :root {
            --primary: #00e676;         /* Verde Neon para Ação e Progresso */
            --secondary: #ff3d00;       /* Laranja/Vermelho para Busca/Foco */
            --blue-accent: #00b0ff;     /* Azul Vibrante para Foco Secundário */
            --bg-dark: #121212;         /* Fundo escuro principal */
            --bg-medium: #282828;       /* Fundo de cards/controles */
            --bg-light: #3a3a3a;        /* Botões / Fundo claro */
            --text-main: #e0e0e0;       /* Texto principal claro */
            --text-secondary: #a0a0a0;  /* Texto secundário/hint */
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.6);
            --radius: 12px;
        }

        /* =================================================================
           # RESET E BASE
           ================================================================= */
        * {
            box-sizing: border-box;
            transition: all 0.2s ease-out; /* Transições suaves para a maioria dos elementos */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        /* =================================================================
           # ESTRUTURA PRINCIPAL DO PLAYER/BUSCA
           ================================================================= */
        #main-container {
            width: 100%;
            max-width: 1200px;
            box-shadow: var(--shadow-dark);
            border-radius: var(--radius);
            overflow: hidden;
            background-color: var(--bg-medium);
        }

        /* =================================================================
           # TELA INICIAL / BUSCADOR (NOVA SEÇÃO)
           ================================================================= */
        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 80px 20px;
            text-align: center;
        }

        #home-screen.hidden {
            display: none;
        }

        #home-screen h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        #home-screen p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 600px;
        }

        #search-container {
            display: flex;
            width: 100%;
            max-width: 550px;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        #search-input {
            flex-grow: 1;
            padding: 15px 25px;
            border: none;
            outline: none;
            background-color: var(--bg-light);
            color: var(--text-main);
            font-size: 1rem;
            border-top-left-radius: 50px;
            border-bottom-left-radius: 50px;
        }
        #search-input::placeholder {
            color: var(--text-secondary);
        }

        #search-button {
            background-color: var(--primary);
            color: var(--bg-dark);
            border: none;
            padding: 0 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #search-button:hover {
            background-color: #00c853; /* Tom ligeiramente mais escuro */
        }
        #search-button:active {
            transform: scale(0.98);
        }
        
        #loading-message, #error-message {
            margin-top: 20px;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-weight: 500;
        }

        #loading-message {
            background-color: var(--blue-accent);
            color: var(--bg-dark);
            display: none; /* Controlado via JS */
        }
        
        #error-message {
            background-color: var(--secondary);
            color: var(--text-main);
            display: none; /* Controlado via JS */
        }


        /* =================================================================
           # PLAYER CONTAINER
           ================================================================= */
        #player-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* Relação de aspecto 16:9 */
            background-color: #000;
            border-radius: var(--radius);
            overflow: hidden;
            display: none; /* Inicialmente oculto */
        }
        
        #player-container.active {
            display: block;
        }

        #player-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            padding-top: 0;
            z-index: 9999;
            border-radius: 0;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Garante que o vídeo seja totalmente visível */
            cursor: pointer;
        }

        /* =================================================================
           # CONTROLES
           ================================================================= */
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));
            padding: 10px 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #player-container:hover .controls,
        #player-container.paused .controls,
        .controls:hover {
            opacity: 1;
            pointer-events: auto;
        }
        
        .controls-row-1 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Barra de Progresso (Progress Bar) */
        #progress-bar-container {
            flex-grow: 1;
            height: 8px;
            background-color: var(--bg-medium);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        #progress-bar-loaded,
        #progress-bar-played {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            border-radius: 4px;
        }

        #progress-bar-loaded {
            background-color: var(--bg-light);
            width: 0; /* Inicializado em JS */
        }

        #progress-bar-played {
            background-color: var(--primary);
            width: 0; /* Inicializado em JS */
            position: relative;
        }

        /* Marker (Círculo na barra de progresso) */
        #progress-marker {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translate(50%, -50%);
            width: 14px;
            height: 14px;
            background-color: var(--primary);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        /* Tooltip de Tempo (mostra o tempo ao passar o mouse) */
        #progress-bar-container:hover::before {
            content: attr(data-time-preview);
            position: absolute;
            top: -30px;
            padding: 4px 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--text-main);
            font-size: 0.8rem;
            border-radius: 4px;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Controles - Segunda Linha */
        .controls-row-2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .controls-left, .controls-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Botões de Controle (Ícones) */
        .control-button {
            background: none;
            border: none;
            color: var(--text-main);
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--primary);
        }
        .control-button i {
            font-size: 24px;
        }

        /* Display de Tempo */
        .time-display {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 0 5px;
        }

        /* Volume Slider */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100px;
        }

        #volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 5px;
            background: var(--bg-light);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        #volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Rate Control */
        #rate-control {
            background-color: var(--bg-light);
            color: var(--text-main);
            border: none;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.9rem;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        #rate-control:hover {
            background-color: var(--bg-light);
            box-shadow: var(--shadow-light);
        }

        /* =================================================================
           # TELA DE OVERLAY (PLAY/PAUSE)
           ================================================================= */
        #play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        #player-container.paused #play-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        #play-large {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            padding: 30px;
            cursor: pointer;
            transform: scale(1);
            transition: transform 0.2s, background-color 0.2s;
        }

        #play-large:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        #play-large i {
            color: var(--text-main);
            font-size: 60px;
        }
        
        /* =================================================================
           # INFORMAÇÕES DO TORRENT
           ================================================================= */
        #torrent-info {
            position: absolute;
            top: 10px;
            left: 20px;
            z-index: 100;
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 6px;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0.8;
        }

        #torrent-info span {
            display: block;
        }

    </style>
</head>
<body>

    <div id="main-container">
        <!-- TELA INICIAL / BUSCADOR -->
        <div id="home-screen">
            <h1>AniStream Player</h1>
            <p>Este player usa WebTorrent. Para "buscar" e reproduzir um vídeo, cole um **Magnet Link** ou a **URL de um arquivo .torrent** no campo abaixo. *Não requer API ou proxy externos.*</p>
            
            <form id="search-form" onsubmit="handleSearch(event)">
                <div id="search-container">
                    <input type="text" id="search-input" placeholder="Cole Magnet Link ou URL do Torrent aqui..." required>
                    <button type="submit" id="search-button">
                        <i class="material-icons">search</i>
                    </button>
                </div>
            </form>
            
            <div id="loading-message">Carregando metadados do Torrent...</div>
            <div id="error-message"></div>
        </div>


        <!-- PLAYER CONTAINER -->
        <div id="player-container">
            <video id="native-video"></video>
            
            <!-- OVERLAY DE PLAY/PAUSE -->
            <div id="play-overlay">
                <div id="play-large">
                    <i class="material-icons">play_arrow</i>
                </div>
            </div>

            <!-- INFORMAÇÕES DO TORRENT -->
            <div id="torrent-info">
                <span id="download-speed">↓ 0.0 KB/s</span>
                <span id="upload-speed">↑ 0.0 KB/s</span>
                <span id="peers-count">Pares: 0</span>
            </div>

            <!-- CONTROLES -->
            <div class="controls">
                <!-- LINHA 1: PROGRESSO -->
                <div class="controls-row-1">
                    <div id="progress-bar-container">
                        <div id="progress-bar-loaded"></div>
                        <div id="progress-bar-played">
                            <div id="progress-marker"></div>
                        </div>
                    </div>
                </div>

                <!-- LINHA 2: BOTÕES E TEMPO -->
                <div class="controls-row-2">
                    <div class="controls-left">
                        <button id="play-button" class="control-button">
                            <i class="material-icons">play_arrow</i>
                        </button>
                        
                        <div class="volume-control">
                            <button id="mute-button" class="control-button">
                                <i class="material-icons">volume_up</i>
                            </button>
                            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
                        </div>
                        
                        <div class="time-display">
                            <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                        </div>
                    </div>
                    
                    <div class="controls-right">
                        <select id="rate-control">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>Normal</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                        
                        <button id="fullscreen-button" class="control-button">
                            <i class="material-icons">fullscreen</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variáveis Globais de Firebase (Mantidas para a estrutura, mesmo que não usadas no WebTorrent)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // =================================================================
        // # VARIÁVEIS DE ELEMENTOS
        // =================================================================
        const mainContainer = document.getElementById('main-container');
        const homeScreen = document.getElementById('home-screen');
        const searchInput = document.getElementById('search-input');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const playerContainer = document.getElementById('player-container');
        const nativeVideo = document.getElementById('native-video');
        const playButton = document.getElementById('play-button');
        const muteButton = document.getElementById('mute-button');
        const volumeSlider = document.getElementById('volume-slider');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBarLoaded = document.getElementById('progress-bar-loaded');
        const progressBarPlayed = document.getElementById('progress-bar-played');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const playLarge = document.getElementById('play-large');
        const rateControl = document.getElementById('rate-control');
        const torrentInfo = document.getElementById('torrent-info');
        const downloadSpeedDisplay = document.getElementById('download-speed');
        const uploadSpeedDisplay = document.getElementById('upload-speed');
        const peersCountDisplay = document.getElementById('peers-count');

        // =================================================================
        // # WEBTORRENT E ESTADO
        // =================================================================
        let webtorrentClient = null;
        let currentTorrent = null;
        let isSeeking = false;

        /**
         * Inicializa o cliente WebTorrent se ainda não estiver inicializado.
         */
        function initializeWebTorrentClient() {
            if (!webtorrentClient) {
                webtorrentClient = new WebTorrent();
                console.log('WebTorrent Client inicializado.');
            }
        }
        
        /**
         * Lida com o envio do formulário de busca e inicia o carregamento do vídeo.
         * @param {Event} e O evento de submit do formulário.
         */
        window.handleSearch = function(e) {
            e.preventDefault();
            const query = searchInput.value.trim();
            errorMessage.style.display = 'none';

            if (!query) {
                showError('Por favor, insira um link magnet ou URL de torrent.');
                return;
            }
            
            // Limpa qualquer torrent anterior
            if (currentTorrent) {
                currentTorrent.destroy();
                currentTorrent = null;
                nativeVideo.src = '';
                nativeVideo.removeAttribute('src');
                nativeVideo.load();
            }

            // Inicia o carregamento
            initializeWebTorrentClient();
            loadVideoFromQuery(query);
        }

        /**
         * Tenta carregar o vídeo a partir do link/query fornecido.
         * @param {string} query O Magnet Link ou URL do Torrent.
         */
        function loadVideoFromQuery(query) {
            loadingMessage.style.display = 'block';
            homeScreen.classList.remove('active');
            
            webtorrentClient.add(query, { destroyStoreOnDestroy: true }, (torrent) => {
                loadingMessage.style.display = 'none';
                currentTorrent = torrent;
                
                // Trata o evento de erro
                torrent.on('error', (err) => {
                    console.error('Erro no Torrent:', err.message);
                    torrent.destroy();
                    showError(`Erro ao carregar o torrent: ${err.message}. Verifique o link.`);
                    resetPlayerToHome();
                });

                // Encontra o maior arquivo de vídeo no torrent
                const file = torrent.files.find((file) => file.name.endsWith('.mp4') || file.name.endsWith('.webm') || file.name.endsWith('.mkv'));

                if (!file) {
                    torrent.destroy();
                    showError('Nenhum arquivo de vídeo compatível (.mp4, .webm) encontrado no torrent.');
                    resetPlayerToHome();
                    return;
                }

                // Cria o stream para o elemento de vídeo
                file.renderTo(nativeVideo, { autoplay: true }, () => {
                    console.log(`Reproduzindo: ${file.name}`);
                    setupPlayerEvents();
                    showPlayer();
                    nativeVideo.play();
                });
            });
        }
        
        /**
         * Exibe a tela do player e oculta a tela inicial.
         */
        function showPlayer() {
            homeScreen.classList.add('hidden');
            playerContainer.classList.add('active');
            playerContainer.classList.remove('paused');
        }

        /**
         * Reseta a tela para a tela inicial/busca.
         */
        function resetPlayerToHome() {
            playerContainer.classList.remove('active');
            playerContainer.classList.remove('paused');
            homeScreen.classList.remove('hidden');
            searchInput.value = '';
            // Garante que o WebTorrent Client esteja parado se não houver torrents ativos
            if (webtorrentClient && webtorrentClient.torrents.length === 0) {
                 // É importante não destruir o cliente se ele for reutilizável
            }
        }

        /**
         * Exibe uma mensagem de erro na tela inicial.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loadingMessage.style.display = 'none';
        }

        // =================================================================
        // # FUNÇÕES AUXILIARES DO PLAYER
        // =================================================================

        function formatTime(seconds) {
            const date = new Date(null);
            date.setSeconds(seconds);
            return date.toISOString().substr(11, 8).replace(/^00:/, '');
        }

        function togglePlay() {
            if (nativeVideo.paused || nativeVideo.ended) {
                nativeVideo.play();
            } else {
                nativeVideo.pause();
            }
        }

        function toggleMute() {
            nativeVideo.muted = !nativeVideo.muted;
        }
        
        function setVolume(vol) {
             nativeVideo.volume = vol;
             nativeVideo.muted = vol === 0;
        }

        function seekRelative(seconds) {
            nativeVideo.currentTime = Math.max(0, Math.min(nativeVideo.duration, nativeVideo.currentTime + seconds));
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else if (playerContainer.requestFullscreen) {
                playerContainer.requestFullscreen();
            }
        }

        function updatePlayButtonIcon() {
            const icon = playButton.querySelector('i');
            const largeIcon = playLarge.querySelector('i');
            if (nativeVideo.paused) {
                icon.textContent = 'play_arrow';
                largeIcon.textContent = 'play_arrow';
                playerContainer.classList.add('paused');
            } else {
                icon.textContent = 'pause';
                largeIcon.textContent = 'pause';
                playerContainer.classList.remove('paused');
            }
        }

        function updateMuteButtonIcon() {
            const icon = muteButton.querySelector('i');
            if (nativeVideo.muted || nativeVideo.volume === 0) {
                icon.textContent = 'volume_off';
            } else if (nativeVideo.volume < 0.5) {
                icon.textContent = 'volume_down';
            } else {
                icon.textContent = 'volume_up';
            }
        }

        function updateTimeDisplay() {
            currentTimeDisplay.textContent = formatTime(nativeVideo.currentTime);
            if (!isFinite(nativeVideo.duration) || nativeVideo.duration === 0) {
                 durationDisplay.textContent = '...';
            } else {
                 durationDisplay.textContent = formatTime(nativeVideo.duration);
            }
        }

        function updateProgressBar() {
            if (!isSeeking && isFinite(nativeVideo.duration) && nativeVideo.duration > 0) {
                const progress = (nativeVideo.currentTime / nativeVideo.duration) * 100;
                progressBarPlayed.style.width = `${progress}%`;
            }
            
            // Atualizar o buffer de carregamento do torrent (não é o buffer nativo do vídeo)
            if (currentTorrent) {
                 const percentLoaded = currentTorrent.progress * 100;
                 progressBarLoaded.style.width = `${percentLoaded}%`;

                 // Atualizar as informações do torrent
                 downloadSpeedDisplay.textContent = `↓ ${currentTorrent.downloadSpeed > 0 ? formatBytes(currentTorrent.downloadSpeed) + '/s' : '0.0 KB/s'}`;
                 uploadSpeedDisplay.textContent = `↑ ${currentTorrent.uploadSpeed > 0 ? formatBytes(currentTorrent.uploadSpeed) + '/s' : '0.0 KB/s'}`;
                 peersCountDisplay.textContent = `Pares: ${currentTorrent.numPeers}`;
            }
        }

        // Função para formatar bytes em unidades legíveis
        function formatBytes(bytes, decimals = 1) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // =================================================================
        // # MANIPULADORES DE EVENTOS
        // =================================================================

        // Manipulador de clique para a barra de progresso
        function handleProgressBarClick(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const percentage = clickX / rect.width;
            if (isFinite(nativeVideo.duration) && nativeVideo.duration > 0) {
                nativeVideo.currentTime = nativeVideo.duration * percentage;
            }
        }
        
        // Manipulador de arrasto na barra de progresso
        function handleProgressDrag(e) {
            if (e.buttons !== 1) return; // Só funciona com botão esquerdo pressionado
            isSeeking = true;
            const rect = progressBarContainer.getBoundingClientRect();
            let clickX = e.clientX - rect.left;
            clickX = Math.max(0, Math.min(rect.width, clickX));
            
            const percentage = clickX / rect.width;
            
            progressBarPlayed.style.width = `${percentage * 100}%`;
            
            if (isFinite(nativeVideo.duration) && nativeVideo.duration > 0) {
                const newTime = nativeVideo.duration * percentage;
                // Atualiza o tempo de exibição durante o arraste
                progressBarContainer.setAttribute('data-time-preview', formatTime(newTime));
                nativeVideo.currentTime = newTime; // Aplica a busca imediatamente
            }
        }
        
        // Manipulador de mousemove para o tooltip de tempo
        function handleProgressMouseMove(e) {
            const rect = progressBarContainer.getBoundingClientRect();
            let hoverX = e.clientX - rect.left;
            hoverX = Math.max(0, Math.min(rect.width, hoverX));
            
            const percentage = hoverX / rect.width;
            
            if (isFinite(nativeVideo.duration) && nativeVideo.duration > 0) {
                 const previewTime = nativeVideo.duration * percentage;
                 progressBarContainer.setAttribute('data-time-preview', formatTime(previewTime));
                 progressBarContainer.style.setProperty('--preview-x', `${hoverX}px`);
                 
                 // Posiciona o tooltip
                 const tooltip = document.querySelector('#progress-bar-container::before');
                 // Nota: A estilização do tooltip via JS direto no ::before é complexa,
                 // mas podemos simular o posicionamento com CSS ou um elemento real.
                 // Manteremos a lógica de 'data-time-preview' para o CSS.
            }
        }
        
        // Finaliza o arraste
        function handleProgressMouseUp() {
            isSeeking = false;
        }


        /**
         * Configura todos os ouvintes de evento para o player.
         */
        function setupPlayerEvents() {
            // Eventos do Vídeo
            nativeVideo.addEventListener('play', updatePlayButtonIcon);
            nativeVideo.addEventListener('pause', updatePlayButtonIcon);
            nativeVideo.addEventListener('volumechange', updateMuteButtonIcon);
            nativeVideo.addEventListener('timeupdate', () => {
                updateTimeDisplay();
                updateProgressBar();
            });
            nativeVideo.addEventListener('loadedmetadata', updateTimeDisplay);
            nativeVideo.addEventListener('dblclick', toggleFullscreen);
            nativeVideo.addEventListener('click', togglePlay);


            // Eventos dos Controles
            playButton.addEventListener('click', togglePlay);
            playLarge.addEventListener('click', togglePlay);
            muteButton.addEventListener('click', toggleMute);
            fullscreenButton.addEventListener('click', toggleFullscreen);

            // Controle de Volume
            volumeSlider.addEventListener('input', (e) => setVolume(parseFloat(e.target.value)));
            
            // Controle de Velocidade
            rateControl.addEventListener('change', (e) => {
                 nativeVideo.playbackRate = parseFloat(e.target.value);
            });

            // Barra de Progresso - Clique para buscar
            progressBarContainer.addEventListener('click', handleProgressBarClick);
            
            // Barra de Progresso - Arrastar para buscar
            progressBarContainer.addEventListener('mousedown', () => {
                document.addEventListener('mousemove', handleProgressDrag);
                document.addEventListener('mouseup', handleProgressMouseUp, { once: true });
            });
            progressBarContainer.addEventListener('mousemove', handleProgressMouseMove);

            // Eventos de Fullscreen
            document.addEventListener('fullscreenchange', () => {
                playerContainer.classList.toggle('fullscreen', document.fullscreenElement === playerContainer);
            });

            // Inicialização de UI
            updatePlayButtonIcon();
            updateMuteButtonIcon();
            updateTimeDisplay();

            // Atalhos de teclado
            document.addEventListener('keydown', (e) => {
                const isInputFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
                if (isInputFocused) return;
                switch (e.key) {
                    case ' ': case 'k': e.preventDefault(); togglePlay(); break;
                    case 'j': e.preventDefault(); seekRelative(-10); break;
                    case 'l': e.preventDefault(); seekRelative(10); break;
                    case 'm': e.preventDefault(); toggleMute(); break;
                    case 'f': e.preventDefault(); toggleFullscreen(); break;
                    case 'ArrowUp': e.preventDefault(); const newVolUp = Math.min(1, nativeVideo.volume + 0.05); setVolume(newVolUp); volumeSlider.value = newVolUp; break;
                    case 'ArrowDown': e.preventDefault(); const newVolDown = Math.max(0, nativeVideo.volume - 0.05); setVolume(newVolDown); volumeSlider.value = newVolDown; break;
                    case 'ArrowLeft': e.preventDefault(); seekRelative(-5); break;
                    case 'ArrowRight': e.preventDefault(); seekRelative(5); break;
                    default: if (e.key >= '0' && e.key <= '9') { e.preventDefault(); const time = (nativeVideo.duration / 10) * parseInt(e.key); nativeVideo.currentTime = time; } break;
                }
            });
        }
        
        // =================================================================
        // # INICIALIZAÇÃO
        // =================================================================

        window.onload = function() {
            console.log('AniStream Player carregado.');
            // O player começa na tela inicial, esperando um link para carregar.
            resetPlayerToHome();
        };

        // Adiciona um listener para a tecla ENTER no input
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('search-form').dispatchEvent(new Event('submit'));
            }
        });
        
    </script>
</body>
</html>
