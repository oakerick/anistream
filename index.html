<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OakCine - Seu Player de Mídia Completo</title>
    <!-- Incluindo Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo WebTorrent CDN (Necessário para links Magnet) -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <!-- Incluindo Material Icons para os controles -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Configuração da fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #151e2a; /* Cinza-Azulado Muito Escuro */
            color: #d1d5db; /* Texto principal cinza claro */
        }
        /* Definição da animação do logo - Agora com glow Esmeralda */
        @keyframes pulse-glow {
            0%, 100% {
                text-shadow: 0 0 5px #10b981, 0 0 10px #10b981, 0 0 15px #10b98140;
                opacity: 0.8;
            }
            50% {
                text-shadow: 0 0 10px #10b981, 0 0 20px #10b981, 0 0 30px #10b981;
                opacity: 1;
            }
        }
        .logo-animated {
            animation: pulse-glow 3s infinite ease-in-out;
            color: #34d399; /* Cor de texto mais clara para o logo */
        }
        /* Estilos da Zona de Drop */
        .drop-zone {
            transition: all 0.3s ease;
            border: 2px dashed #4b5563;
        }
        .drop-zone.drag-over {
            border-color: #10b981; /* Esmeralda de destaque */
            background-color: #1f2937;
        }

        /* Estilos da Barra de Controles Customizada */
        .controls-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px; 
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; 
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.0) 100%);
        }
        .player-wrapper:hover .controls-overlay {
            opacity: 1;
            pointer-events: auto; 
        }
        .controls-bar {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            pointer-events: auto; 
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        .control-button {
            background: none;
            border: none;
            color: #fff;
            padding: 5px;
            cursor: pointer;
            outline: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
        }
        .control-button:hover {
            color: #34d399; /* Esmeralda de destaque */
        }
        .material-icons {
            font-size: 28px;
        }
        .time-display {
            font-size: 0.9rem;
            color: #d1d5db;
            white-space: nowrap; 
        }
        /* Barra de Progresso Customizada */
        .progress-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 12px;
            cursor: pointer;
            background: transparent;
        }
        .progress-track {
            position: relative;
            width: 100%;
            height: 4px;
            background: #4b5563;
            transition: height 0.1s;
        }
        .player-wrapper:hover .progress-track {
            height: 8px;
        }
        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #10b981; /* Esmeralda de destaque */
            width: 0%;
        }
        .progress-thumb {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
            width: 15px;
            height: 15px;
            background: #34d399; /* Esmeralda de destaque */
            border-radius: 50%;
            opacity: 0; 
            transition: opacity 0.1s, transform 0.1s;
        }
        .progress-bar-container:hover .progress-thumb {
            opacity: 1;
        }
        /* Volume Slider */
        .volume-slider {
            -webkit-appearance: none;
            width: 80px;
            height: 6px;
            background: #4b5563;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #34d399; /* Esmeralda de destaque */
            cursor: pointer;
        }
        
    </style>
</head>
<body class="flex items-start justify-center min-h-screen py-10">

    <div id="app-container" class="w-full max-w-4xl mx-4 lg:mx-auto bg-gray-900 shadow-2xl rounded-xl overflow-hidden p-6 space-y-6">

        <!-- 1. LOGO OAKCINE ANIMADA (Acima do Player) -->
        <header class="text-center mb-6">
            <h1 class="logo-animated text-5xl font-extrabold">
                OakCine
            </h1>
            <p class="text-sm text-gray-500 mt-1">Seu Player Multimídia</p>
        </header>

        <!-- 2. PLAYER DE MÍDIA (Com Controles Customizados) -->
        <div class="player-wrapper relative w-full aspect-video bg-black rounded-lg shadow-2xl group" id="player-wrapper">
            <!-- O atributo 'controls' foi removido para usarmos os customizados -->
            <video id="mediaPlayer" class="w-full h-full rounded-lg object-contain" poster="https://placehold.co/1280x720/1f2937/d1d5db?text=Nenhuma+M%C3%ADdia+Carregada" tabindex="-1">
                Seu navegador não suporta a tag de vídeo.
            </video>

            <div class="controls-overlay">
                
                <!-- Barra de Progresso -->
                <div class="progress-bar-container" id="progress-container">
                    <div class="progress-track">
                        <div class="progress-fill" id="progress-played">
                            <div class="progress-thumb"></div>
                        </div>
                    </div>
                </div>

                <!-- Barra de Controles Inferior (Prompts do Player) -->
                <div class="controls-bar">
                    <!-- Play/Pause -->
                    <button class="control-button" id="play-pause-button" aria-label="Play/Pause">
                        <span class="material-icons">play_arrow</span>
                    </button>

                    <!-- VOLTAR 10s -->
                    <button class="control-button" id="rewind-button" aria-label="Voltar 10 segundos">
                        <span class="material-icons">replay_10</span>
                    </button>
                    
                    <!-- AVANÇAR 10s -->
                    <button class="control-button" id="forward-button" aria-label="Avançar 10 segundos">
                        <span class="material-icons">forward_10</span>
                    </button>

                    <!-- PRÓXIMO EPISÓDIO (Simulado) -->
                    <button class="control-button text-sm" id="next-episode-button" aria-label="Próximo Episódio">
                        <span class="material-icons">skip_next</span>
                    </button>

                    <!-- PRÓXIMO ITEM PLAYLIST (Simulado) -->
                    <button class="control-button text-sm" id="next-track-button" aria-label="Próximo Item na Playlist">
                        <span class="material-icons">queue_play_next</span>
                    </button>

                    <!-- Tempo Atual/Duração -->
                    <div class="time-display" id="time-display">0:00 / 0:00</div>

                    <div class="flex-grow"></div> <!-- Espaçador -->
                    
                    <!-- Volume -->
                    <div class="flex items-center gap-1">
                        <button class="control-button" id="mute-button" aria-label="Mudo">
                            <span class="material-icons" id="volume-icon">volume_up</span>
                        </button>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" class="volume-slider" aria-label="Controle de Volume">
                    </div>
                    
                    <!-- Tela Cheia -->
                    <button class="control-button" id="fullscreen-button" aria-label="Tela Cheia">
                        <span class="material-icons">fullscreen</span>
                    </button>
                </div>
            </div>
            
            <!-- Feedback de Ação Rápida (Ex: Ícone de Pular 10s) -->
            <div id="action-feedback" class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-150 pointer-events-none">
                <span class="material-icons text-7xl text-white bg-black bg-opacity-50 rounded-full p-4"></span>
            </div>
        </div>

        <!-- 3. INFORMAÇÕES DA MÍDIA (Abaixo do Player) -->
        <div id="mediaInfoContainer" class="bg-gray-800 p-5 rounded-xl shadow-inner mt-6 border border-gray-700">
            <h2 class="text-xl font-bold text-emerald-400 mb-3 border-b border-gray-700 pb-2">Informações da Mídia Carregada</h2>
            <div id="mediaMetadata" class="text-gray-400 space-y-2 text-sm">
                <p>Nenhum arquivo carregado. Use os prompts abaixo para iniciar a reprodução.</p>
            </div>
            
            <!-- NOVO: Container para as Estatísticas de Torrent -->
            <div id="torrentStatsContainer" class="hidden mt-4 pt-4 border-t border-gray-700">
                <h3 class="text-lg font-bold text-emerald-400 mb-2">Estatísticas de Torrent</h3>
                <div class="grid grid-cols-3 gap-4 text-sm text-gray-300">
                    <div>
                        <p class="text-gray-500">Seeds/Peers:</p>
                        <p id="stats-peers" class="font-semibold text-white">0</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Download:</p>
                        <p id="stats-download" class="font-semibold text-white">0 B/s</p>
                    </div>
                    <div>
                        <p class="text-gray-500">Upload:</p>
                        <p id="stats-upload" class="font-semibold text-white">0 B/s</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. PROMPTS / CONTROLES DE CARREGAMENTO -->
        <div class="space-y-5 pt-5 border-t border-gray-800">
            <h2 class="text-2xl font-bold text-white">Carregar Conteúdo</h2>

            <!-- A. Prompt: Selecionar Arquivo/Arrastar e Soltar -->
            <div id="fileDropZone" class="drop-zone flex flex-col items-center justify-center p-8 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-emerald-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p class="text-gray-300 font-medium text-center">Clique para **Selecionar Arquivo** ou Arraste e Solte Mídia (Vídeo/Áudio)</p>
                <input type="file" id="fileInput" accept="video/*,audio/*" class="hidden">
            </div>
            
            <!-- B. Prompt: Magnet Link -->
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <input type="text" id="magnetLinkInput" placeholder="Insira o link Magnet (começa com 'magnet:?xt=urn:btih:...') aqui" class="flex-grow p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-emerald-500 focus:border-emerald-500 placeholder-gray-400" value="magnet:?xt=urn:btih:6a9759d0247b7c5332d7904899ad177114e0409f&dn=sintel">
                <button id="loadMagnetBtn" class="bg-emerald-600 text-white p-3 rounded-lg font-semibold hover:bg-emerald-700 transition duration-300 shadow-lg flex-shrink-0">
                    Carregar Magnet
                </button>
            </div>
        </div>
        
    </div>

    <!-- Modal de Mensagem (Substitui alert()) -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-emerald-500">
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-3">Mensagem</h3>
            <p id="modalMessage" class="text-gray-300 mb-4"></p>
            <button onclick="document.getElementById('messageModal').classList.add('hidden'); document.getElementById('messageModal').classList.remove('flex');" class="w-full bg-emerald-600 text-white py-2 rounded-lg hover:bg-emerald-700 transition duration-300">
                OK
            </button>
        </div>
    </div>


    <script type="module">
        // =================================================================
        // # INICIALIZAÇÃO DE VARIÁVEIS E FUNÇÕES DE UTILIDADE
        // =================================================================
        
        // Importações e configuração do Firebase (MANDATÓRIO para o ambiente Canvas)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variáveis globais do Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let client; // Cliente WebTorrent
        let currentTorrent = null;
        let statsInterval = null;

        const mediaPlayer = document.getElementById('mediaPlayer');
        const mediaMetadata = document.getElementById('mediaMetadata');
        const fileInput = document.getElementById('fileInput');
        const fileDropZone = document.getElementById('fileDropZone');
        const magnetLinkInput = document.getElementById('magnetLinkInput');
        const loadMagnetBtn = document.getElementById('loadMagnetBtn');
        
        // Controles Customizados (e.g. play/pause buttons)
        const playPauseButton = document.getElementById('play-pause-button');
        const rewindButton = document.getElementById('rewind-button');
        const forwardButton = document.getElementById('forward-button');
        const nextEpisodeButton = document.getElementById('next-episode-button');
        const nextTrackButton = document.getElementById('next-track-button');
        const muteButton = document.getElementById('mute-button');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeIcon = document.getElementById('volume-icon');
        const progressContainer = document.getElementById('progress-container');
        const progressPlayed = document.getElementById('progress-played');
        const timeDisplay = document.getElementById('time-display');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const playerWrapper = document.getElementById('player-wrapper');
        const actionFeedback = document.getElementById('action-feedback');
        
        // Elementos de Estatísticas de Torrent
        const torrentStatsContainer = document.getElementById('torrentStatsContainer');
        const statsPeers = document.getElementById('stats-peers');
        const statsDownload = document.getElementById('stats-download');
        const statsUpload = document.getElementById('stats-upload');


        let isSeeking = false;
        let originalVolume = 1;

        // Função para mostrar o modal de mensagem (substituto do alert)
        function showMessage(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
            document.getElementById('messageModal').classList.add('flex');
        }

        /**
         * Formata o tempo de segundos para MM:SS ou HH:MM:SS.
         */
        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) return '0:00';
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);

            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(seconds).padStart(2, '0');

            if (hours > 0) {
                return `${hours}:${String(minutes).padStart(2, '0')}:${paddedSeconds}`;
            }
            return `${minutes}:${paddedSeconds}`;
        }

        /**
         * Formata bytes/s para Kb/s, Mb/s, etc.
         */
        function formatSpeed(bytes) {
            if (bytes === 0) return '0 B/s';
            const k = 1024;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // =================================================================
        // # INICIALIZAÇÃO E AUTENTICAÇÃO DO FIREBASE (MANDATÓRIO)
        // =================================================================

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Usuário autenticado com token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase: Usuário autenticado anonimamente.");
                    }
                } else {
                    console.warn("Firebase: Configuração não fornecida. Continuando sem DB.");
                }
            } catch (error) {
                console.error("Firebase: Erro na inicialização ou autenticação:", error);
            }
        }
        
        // =================================================================
        // # FUNÇÕES DE TORRENT
        // =================================================================

        /**
         * Limpa o torrent anterior (se houver) e zera as estatísticas.
         */
        function destroyCurrentTorrent() {
            if (currentTorrent) {
                currentTorrent.destroy();
                currentTorrent = null;
            }
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            // Oculta e reseta o display das estatísticas
            torrentStatsContainer.classList.add('hidden');
            statsPeers.textContent = '0';
            statsDownload.textContent = '0 B/s';
            statsUpload.textContent = '0 B/s';
            mediaPlayer.src = '';
            mediaPlayer.load();
        }

        /**
         * Inicia o cliente WebTorrent e adiciona o magnet link.
         * @param {string} magnetLink O link magnet.
         */
        function startTorrent(magnetLink) {
            destroyCurrentTorrent();
            
            // Exibir container de estatísticas
            torrentStatsContainer.classList.remove('hidden');

            const torrent = client.add(magnetLink, (t) => {
                currentTorrent = t;
                showMessage("Torrent Iniciado", `Download de "${t.name}" iniciado. Buscando pares...`);

                // Encontra o maior arquivo de mídia (geralmente o vídeo principal)
                const file = t.files.find(f => f.name.endsWith('.mp4') || f.name.endsWith('.mkv') || f.name.endsWith('.ogg') || f.name.endsWith('.webm') || f.name.endsWith('.mp3') || f.name.endsWith('.wav'));

                if (!file) {
                    showMessage("Erro", "Nenhum arquivo de mídia suportado encontrado neste torrent.");
                    destroyCurrentTorrent();
                    return;
                }

                // Carrega o arquivo diretamente no player de vídeo
                file.renderTo(mediaPlayer, {
                    autoplay: true 
                });

                // Atualiza os metadados
                mediaMetadata.innerHTML = `
                    <p><span class="font-bold text-emerald-300">Status:</span> Carregando (Pares Conectados: ${t.numPeers})</p>
                    <p><span class="font-bold text-white">Nome do Torrent:</span> ${t.name}</p>
                    <p><span class="font-bold text-white">Arquivo:</span> ${file.name}</p>
                    <p><span class="font-bold text-white">Tamanho:</span> ${(t.length / (1024 * 1024)).toFixed(2)} MB</p>
                `;
            });
            
            // Lidar com erros de torrent
            torrent.on('error', (err) => {
                console.error("Erro no Torrent:", err.message);
                showMessage("Erro de Torrent", `Ocorreu um erro: ${err.message}. Verifique o link e tente novamente.`);
                destroyCurrentTorrent();
            });

            // Configurar intervalo para atualização das estatísticas
            if (!statsInterval) {
                statsInterval = setInterval(updateTorrentStats, 1000);
            }
        }

        /**
         * Atualiza o display das estatísticas de download/upload/peers.
         */
        function updateTorrentStats() {
            if (!currentTorrent) return;

            // Seeds/Peers
            const peers = currentTorrent.numPeers;
            statsPeers.textContent = peers;

            // Download Speed
            const downloadSpeed = currentTorrent.downloadSpeed;
            statsDownload.textContent = formatSpeed(downloadSpeed);

            // Upload Speed
            const uploadSpeed = currentTorrent.uploadSpeed;
            statsUpload.textContent = formatSpeed(uploadSpeed);
            
            // Atualiza status na info da mídia
             if (peers > 0) {
                 mediaMetadata.querySelector('.text-emerald-300').textContent = `Baixando... (${(currentTorrent.progress * 100).toFixed(2)}%)`;
             } else {
                 mediaMetadata.querySelector('.text-emerald-300').textContent = `Aguardando Pares...`;
             }
        }


        // =================================================================
        // # FUNÇÕES DO PLAYER DE MÍDIA
        // =================================================================

        /**
         * Atualiza o player e exibe os metadados da mídia na UI (usado para arquivos locais).
         */
        function loadMediaInfoLocal(mediaSource, name, type, size = 'Local File') {
            destroyCurrentTorrent(); // Limpa qualquer torrent ativo

            mediaPlayer.src = mediaSource;
            mediaPlayer.poster = ''; // Remove o poster
            mediaPlayer.load();

            let displaySize = (typeof size === 'number') ? (size / (1024 * 1024)).toFixed(2) + ' MB' : size;
            
            mediaMetadata.innerHTML = `
                <p><span class="font-bold text-emerald-300">Status:</span> Arquivo local carregado. Clique no Play para iniciar.</p>
                <p><span class="font-bold text-white">Nome:</span> ${name}</p>
                <p><span class="font-bold text-white">Tipo:</span> ${type}</p>
                <p><span class="font-bold text-white">Tamanho:</span> ${displaySize}</p>
                <p><span class="font-bold text-white">Origem:</span> Arquivo Local</p>
            `;
            mediaPlayer.style.display = 'block';
            
            mediaPlayer.play().catch(e => {
                console.log("Reprodução automática bloqueada ou erro:", e);
                playPauseButton.innerHTML = '<span class="material-icons">play_arrow</span>';
            });
        }
        
        /**
         * Alterna entre Play e Pause.
         */
        function togglePlay() {
            if (!mediaPlayer.src) {
                showMessage("Atenção", "Nenhuma mídia carregada. Por favor, selecione um arquivo ou insira um Magnet Link.");
                return;
            }

            if (mediaPlayer.paused || mediaPlayer.ended) {
                mediaPlayer.play();
                showActionFeedback('play_arrow');
            } else {
                mediaPlayer.pause();
                showActionFeedback('pause');
            }
        }

        /**
         * Alterna o estado mudo e atualiza o ícone de volume.
         */
        function toggleMute() {
            if (mediaPlayer.muted) {
                mediaPlayer.muted = false;
                volumeSlider.value = originalVolume; 
            } else {
                if (mediaPlayer.volume > 0) {
                    originalVolume = mediaPlayer.volume;
                }
                mediaPlayer.muted = true;
                volumeSlider.value = 0; 
            }
            updateVolumeIcon();
            showActionFeedback(mediaPlayer.muted ? 'volume_off' : 'volume_up');
        }

        /**
         * Atualiza o ícone de volume com base no estado do player.
         */
        function updateVolumeIcon() {
            const vol = mediaPlayer.volume;
            const muted = mediaPlayer.muted || vol === 0;
            
            let icon = 'volume_up';
            if (muted) icon = 'volume_off';
            else if (vol < 0.5) icon = 'volume_down';
            
            volumeIcon.textContent = icon;
            if (vol > 0) {
                mediaPlayer.muted = false;
            }
        }

        /**
         * Busca para um tempo específico com base na posição do clique/arrasto na barra de progresso.
         */
        function seek(e) {
            if (!mediaPlayer.duration) return;

            const rect = progressContainer.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const percent = Math.max(0, Math.min(1, clickX / width));
            const newTime = mediaPlayer.duration * percent;
            mediaPlayer.currentTime = newTime;
        }

        /**
         * Atualiza o display de tempo e a barra de progresso.
         */
        function updateTimeDisplay() {
            const currentTime = mediaPlayer.currentTime;
            const duration = mediaPlayer.duration;
            
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;

            const percent = (currentTime / duration) * 100;
            progressPlayed.style.width = `${percent}%`;
        }

        /**
         * Busca relativa no vídeo (usado pelos botões de skip).
         * @param {number} seconds - Segundos para avançar (positivo) ou retroceder (negativo).
         */
        function seekRelative(seconds) {
            if (!mediaPlayer.src) return;
            mediaPlayer.currentTime = mediaPlayer.currentTime + seconds;
            showActionFeedback(seconds > 0 ? 'forward_10' : 'replay_10');
        }

        /**
         * Alterna o modo de tela cheia.
         */
        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
                fullscreenButton.innerHTML = '<span class="material-icons">fullscreen</span>';
            } else {
                playerWrapper.requestFullscreen().catch(err => {
                    console.error(`Erro ao tentar entrar em tela cheia: ${err.message}`);
                    showMessage("Erro", "Não foi possível ativar o modo tela cheia.");
                });
                fullscreenButton.innerHTML = '<span class="material-icons">fullscreen_exit</span>';
            }
        }
        
        /**
         * Exibe um feedback visual (ícone de ação) no centro do player.
         * @param {string} iconName - O nome do ícone do Material Icons.
         */
        function showActionFeedback(iconName) {
            const feedbackIcon = actionFeedback.querySelector('.material-icons');
            feedbackIcon.textContent = iconName;
            actionFeedback.classList.add('opacity-100');
            setTimeout(() => {
                actionFeedback.classList.remove('opacity-100');
            }, 500);
        }

        // =================================================================
        // # CONFIGURAÇÃO DE EVENT LISTENERS
        // =================================================================
        
        function setupEventListeners() {
            // --- Handlers de Carregamento ---

            // Clique na Zona de Drop
            fileDropZone.addEventListener('click', () => fileInput.click());

            // Carregar Arquivo após seleção
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const fileURL = URL.createObjectURL(file);
                    loadMediaInfoLocal(fileURL, file.name, file.type, file.size);
                }
            });

            // Lógica de Drag & Drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, e => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, () => fileDropZone.classList.add('drag-over'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, () => fileDropZone.classList.remove('drag-over'), false);
            });
            fileDropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && (file.type.startsWith('video/') || file.type.startsWith('audio/'))) {
                    const fileURL = URL.createObjectURL(file);
                    loadMediaInfoLocal(fileURL, file.name, file.type, file.size);
                } else if (file) {
                    showMessage("Atenção", "O arquivo arrastado não é um arquivo de mídia (vídeo ou áudio).");
                }
            }, false);

            // Carregar Magnet Link
            loadMagnetBtn.addEventListener('click', () => {
                const magnetLink = magnetLinkInput.value.trim();
                if (magnetLink.startsWith('magnet:?')) {
                    startTorrent(magnetLink);
                } else if (magnetLink.length > 0) {
                    showMessage("Erro de Formato", "O link não é um Magnet Link válido. Ele deve começar com 'magnet:?'.");
                } else {
                    showMessage("Atenção", "Por favor, insira um link Magnet.");
                }
            });

            // --- Handlers dos Prompts do Player (Customizados) ---

            // Play/Pause
            playPauseButton.onclick = togglePlay;
            mediaPlayer.onclick = togglePlay;

            mediaPlayer.onpause = () => playPauseButton.innerHTML = '<span class="material-icons">play_arrow</span>';
            mediaPlayer.onplay = () => playPauseButton.innerHTML = '<span class="material-icons">pause</span>';
            
            // Voltar 10s
            rewindButton.onclick = () => seekRelative(-10);

            // Avançar 10s
            forwardButton.onclick = () => seekRelative(10);
            
            // Próximo Episódio (Simulado)
            nextEpisodeButton.onclick = () => {
                if (!mediaPlayer.src) {
                    showMessage("Atenção", "Nenhuma mídia carregada.");
                    return;
                }
                mediaPlayer.currentTime = mediaPlayer.duration - 5; 
                showMessage("Ação SimuLada", "Pulando para o próximo episódio.");
                showActionFeedback('skip_next');
            };

            // Avançar Tempo Playlist / Próximo Item (Simulado)
            nextTrackButton.onclick = () => {
                if (!mediaPlayer.src) {
                    showMessage("Atenção", "Nenhuma mídia carregada.");
                    return;
                }
                showMessage("Ação SimuLada", "Avançando para o próximo item da playlist.");
                showActionFeedback('queue_play_next');
            };


            // Volume/Mudo
            muteButton.onclick = toggleMute;
            volumeSlider.oninput = (e) => {
                mediaPlayer.volume = parseFloat(e.target.value);
                updateVolumeIcon();
            };
            mediaPlayer.onvolumechange = updateVolumeIcon;

            // Progresso/Busca
            mediaPlayer.ontimeupdate = updateTimeDisplay;
            
            // Lógica de Busca (Seek) com Mouse
            progressContainer.onmousedown = (e) => {
                if (e.button !== 0) return;
                isSeeking = true;
                seek(e);
            };
            document.onmousemove = (e) => {
                if (isSeeking) seek(e);
            };
            document.onmouseup = () => {
                isSeeking = false;
            };

            // Tela Cheia
            fullscreenButton.onclick = toggleFullscreen;
            document.onfullscreenchange = () => {
                const icon = document.fullscreenElement ? 'fullscreen_exit' : 'fullscreen';
                fullscreenButton.innerHTML = `<span class="material-icons">${icon}</span>`;
            };
        }

        // =================================================================
        // # INÍCIO DA APLICAÇÃO
        // =================================================================

        window.onload = function () {
            initializeFirebase(); // Inicialização obrigatória
            // Inicializa o cliente WebTorrent
            client = new WebTorrent();
            setupEventListeners(); // Configura todos os eventos
            
            // Carrega o Magnet Link padrão no início
            const initialMagnet = magnetLinkInput.value.trim();
            if (initialMagnet) {
                 startTorrent(initialMagnet);
            }
        }
    </script>
</body>
</html>
