<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OakCine - AI Powered Player</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- WebTorrent -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
        }

        /* Animação do Logo */
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e40; }
            50% { text-shadow: 0 0 20px #22c55e, 0 0 30px #22c55e; }
        }
        .logo-glow { animation: pulse-glow 3s infinite ease-in-out; }

        /* Player Custom Controls */
        .video-container:hover .controls-overlay { opacity: 1; }
        .controls-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
            transition: opacity 0.3s ease;
        }
        
        /* Slider */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px; width: 12px;
            border-radius: 50%; background: #22c55e;
            margin-top: -4px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #4b5563;
            border-radius: 2px;
        }
    </style>
</head>
<body class="flex justify-center min-h-screen p-4 md:p-8">

    <div class="w-full max-w-6xl space-y-6">

        <!-- 1. CABEÇALHO E LOGO -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-gray-900 p-6 rounded-2xl shadow-2xl border border-gray-800">
            <div class="flex items-center gap-3 mb-4 md:mb-0">
                <span class="material-icons text-4xl text-green-500">smart_display</span>
                <div>
                    <h1 class="text-4xl font-black tracking-tighter text-white logo-glow">
                        Oak<span class="text-green-500">Cine</span>
                    </h1>
                    <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">AI Powered Streaming</p>
                </div>
            </div>
            
            <!-- Status do WebTorrent -->
            <div id="torrentStatus" class="hidden items-center gap-4 bg-gray-800 px-4 py-2 rounded-full border border-gray-700 text-sm">
                <div class="flex items-center gap-1 text-green-400">
                    <span class="material-icons text-sm">download</span>
                    <span id="dlSpeed">0 KB/s</span>
                </div>
                <div class="flex items-center gap-1 text-blue-400">
                    <span class="material-icons text-sm">people</span>
                    <span id="peersCount">0</span>
                </div>
            </div>
        </header>

        <!-- 2. MENU DE NAVEGAÇÃO -->
        <nav class="bg-gray-900 p-2 rounded-xl border border-gray-800 shadow-lg">
            <ul class="flex justify-center md:justify-start gap-2 overflow-x-auto">
                <li><button onclick="showSection('search')" class="px-6 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition">Busca AI</button></li>
                <li><button onclick="showSection('manual')" class="px-6 py-2 rounded-lg hover:bg-gray-800 text-gray-300 transition">Link Manual</button></li>
                <li><button onclick="showSection('local')" class="px-6 py-2 rounded-lg hover:bg-gray-800 text-gray-300 transition">Arquivo Local</button></li>
            </ul>
        </nav>

        <!-- 3. ÁREA DE CONTEÚDO -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- COLUNA ESQUERDA: PLAYER -->
            <section class="lg:col-span-2 space-y-4">
                <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl group video-container">
                    <video id="videoPlayer" class="w-full h-full object-contain"></video>
                    
                    <!-- Overlay de Loading -->
                    <div id="loadingOverlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mb-3"></div>
                        <p id="loadingText" class="text-green-400 font-mono text-sm">Carregando...</p>
                    </div>

                    <!-- Controles Customizados -->
                    <div class="controls-overlay absolute bottom-0 left-0 right-0 p-4 opacity-0 transition-opacity z-30">
                        <!-- Barra de Progresso -->
                        <div class="relative h-1 bg-gray-600 rounded-full cursor-pointer mb-4 group/progress" id="progressBarContainer">
                            <div id="progressBar" class="absolute top-0 left-0 h-full bg-green-500 rounded-full w-0"></div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <button id="playPauseBtn" class="text-white hover:text-green-400 transition"><span class="material-icons text-3xl">play_arrow</span></button>
                                <button id="muteBtn" class="text-white hover:text-gray-300"><span class="material-icons">volume_up</span></button>
                                <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-20">
                                <span id="timeDisplay" class="text-xs text-gray-300 font-mono ml-2">00:00 / 00:00</span>
                            </div>
                            <button id="fullscreenBtn" class="text-white hover:text-green-400"><span class="material-icons">fullscreen</span></button>
                        </div>
                    </div>
                </div>

                <!-- Informações da Mídia -->
                <div id="mediaInfo" class="bg-gray-900 p-6 rounded-xl border border-gray-800">
                    <h2 class="text-xl font-bold text-white mb-2 flex items-center gap-2">
                        <span class="material-icons text-green-500">info</span> Detalhes da Mídia
                    </h2>
                    <p id="mediaTitle" class="text-gray-400 text-sm">Nenhuma mídia carregada.</p>
                </div>
            </section>

            <!-- COLUNA DIREITA: PROMPTS E RESULTADOS -->
            <aside class="lg:col-span-1 bg-gray-900 p-6 rounded-xl border border-gray-800 h-fit">
                
                <!-- SEÇÃO 1: BUSCA AI -->
                <div id="section-search" class="space-y-4">
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Busca Inteligente</h3>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Ex: Matrix 1080p, One Piece..." 
                               class="w-full bg-gray-800 border border-gray-700 rounded-lg py-3 px-4 pl-10 text-white focus:ring-2 focus:ring-green-500 focus:outline-none transition">
                        <span class="material-icons absolute left-3 top-3.5 text-gray-500">search</span>
                    </div>
                    <button id="searchBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg flex items-center justify-center gap-2">
                        <span class="material-icons text-sm">auto_awesome</span> Buscar Torrents
                    </button>
                    
                    <!-- Lista de Resultados -->
                    <div id="resultsList" class="space-y-3 mt-4 max-h-[400px] overflow-y-auto custom-scrollbar hidden">
                        <!-- Resultados injetados aqui -->
                    </div>
                </div>

                <!-- SEÇÃO 2: MANUAL -->
                <div id="section-manual" class="hidden space-y-4">
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Link Direto</h3>
                    <textarea id="magnetInput" rows="3" placeholder="Cole aqui seu Magnet Link ou Hash..." 
                              class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm text-white focus:ring-2 focus:ring-green-500 focus:outline-none"></textarea>
                    <button id="loadMagnetBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                        Carregar Link
                    </button>
                </div>

                <!-- SEÇÃO 3: LOCAL -->
                <div id="section-local" class="hidden space-y-4">
                    <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Arquivo Local</h3>
                    <div id="dropZone" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:bg-gray-800 hover:border-green-500 transition cursor-pointer">
                        <span class="material-icons text-4xl text-gray-500 mb-2">upload_file</span>
                        <p class="text-sm text-gray-400">Clique ou arraste arquivos</p>
                        <input type="file" id="fileInput" class="hidden" accept="video/*,.torrent">
                    </div>
                </div>

            </aside>
        </div>

    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        const API_KEY = ""; // ⚠️ Insira sua chave Gemini aqui para a busca funcionar
        const GOOGLE_SEARCH_API = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const client = new WebTorrent();
        let currentTorrent = null;

        // Elementos DOM
        const video = document.getElementById('videoPlayer');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const networkStatus = document.getElementById('networkStatus');
        const resultsList = document.getElementById('resultsList');
        
        // --- NAVEGAÇÃO DE ABAS ---
        window.showSection = (sectionId) => {
            ['search', 'manual', 'local'].forEach(id => {
                document.getElementById(`section-${id}`).classList.add('hidden');
            });
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');
        };

        // --- BUSCA COM IA (GEMINI) ---
        async function searchTorrents() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return alert("Digite algo para buscar.");

            resultsList.innerHTML = '<div class="text-center text-gray-500 py-4"><div class="animate-spin inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div> Buscando...</div>';
            resultsList.classList.remove('hidden');

            const systemPrompt = `Você é um motor de busca de torrents de vídeo. 
            Para a consulta "${query}", encontre links magnet REAIS e funcionais.
            Retorne APENAS um JSON array estrito: [{"title": "Nome", "magnet": "magnet:?xt=...", "size": "Size", "seeds": 123}].
            Se não encontrar links exatos, gere magnets baseados em hash válidos para demonstração.`;

            try {
                const response = await fetch(`${GOOGLE_SEARCH_API}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }],
                        tools: [{ google_search: {} }]
                    })
                });

                const data = await response.json();
                let results = [];
                
                try {
                    const text = data.candidates[0].content.parts[0].text;
                    const jsonMatch = text.match(/\[[\s\S]*\]/);
                    if(jsonMatch) results = JSON.parse(jsonMatch[0]);
                } catch(e) { console.error("Erro parse:", e); }

                // Mock de fallback se a API falhar ou não tiver chave
                if(results.length === 0) {
                    results = [
                        { title: "Sintel (4K) - Demo", size: "129 MB", seeds: 50, magnet: "magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel" },
                        { title: "Big Buck Bunny", size: "276 MB", seeds: 80, magnet: "magnet:?xt=urn:btih:dd8255ecdc7ca55fb0bbf81323d87062db1f6d1c&dn=Big+Buck+Bunny" }
                    ];
                }

                renderResults(results);

            } catch (error) {
                console.error(error);
                resultsList.innerHTML = '<p class="text-red-400 text-center text-sm">Erro na busca. Verifique a API Key.</p>';
            }
        }

        function renderResults(results) {
            resultsList.innerHTML = '';
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-green-500 transition cursor-pointer group';
                div.innerHTML = `
                    <h4 class="font-bold text-sm text-white group-hover:text-green-400 mb-1 truncate">${item.title}</h4>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span><i class="material-icons text-[10px] align-middle">sd_storage</i> ${item.size}</span>
                        <span class="text-green-500"><i class="material-icons text-[10px] align-middle">people</i> ${item.seeds}</span>
                    </div>
                `;
                div.onclick = () => loadMagnet(item.magnet);
                resultsList.appendChild(div);
            });
        }

        // --- PLAYER CORE ---
        
        function loadMagnet(magnet) {
            if(currentTorrent) {
                currentTorrent.destroy();
                currentTorrent = null;
            }
            
            showLoading("Conectando aos peers...");
            networkStatus.classList.remove('hidden');
            networkStatus.classList.add('flex');

            client.add(magnet, torrent => {
                currentTorrent = torrent;
                showLoading("Baixando metadados...");
                
                const file = torrent.files.find(f => f.name.match(/\.(mp4|mkv|webm|ogg)$/i));
                
                if(file) {
                    showLoading(`Carregando: ${file.name}`);
                    document.getElementById('mediaTitle').innerHTML = `Reproduzindo: <span class="text-green-400">${file.name}</span>`;
                    
                    file.renderTo(video, { autoplay: true }, err => {
                        if(err) console.error(err);
                        hideLoading();
                    });
                } else {
                    alert("Vídeo não encontrado no torrent.");
                    hideLoading();
                }

                torrent.on('download', () => {
                    document.getElementById('dlSpeed').innerText = (torrent.downloadSpeed / 1024 / 1024).toFixed(1) + ' MB/s';
                    document.getElementById('peersCount').innerText = torrent.numPeers;
                });
            });
        }

        function loadFile(file) {
            const url = URL.createObjectURL(file);
            video.src = url;
            document.getElementById('mediaTitle').innerHTML = `Arquivo Local: <span class="text-blue-400">${file.name}</span>`;
            video.play();
        }

        // --- UTILITÁRIOS UI ---
        function showLoading(msg) {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            document.getElementById('loadingText').innerText = msg;
        }
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.classList.remove('flex');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('searchBtn').onclick = searchTorrents;
        document.getElementById('searchInput').onkeydown = (e) => e.key === 'Enter' && searchTorrents();
        
        document.getElementById('loadMagnetBtn').onclick = () => loadMagnet(document.getElementById('magnetInput').value);
        
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => e.target.files[0] && loadFile(e.target.files[0]);
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-green-500', 'bg-gray-800'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-green-500', 'bg-gray-800'); };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-green-500', 'bg-gray-800');
            if(e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
        };

        // Controles Básicos
        const playBtn = document.getElementById('playPauseBtn');
        video.onplay = () => playBtn.innerHTML = '<span class="material-icons text-3xl">pause</span>';
        video.onpause = () => playPauseBtn.innerHTML = '<span class="material-icons text-3xl">play_arrow</span>';
        playBtn.onclick = () => video.paused ? video.play() : video.pause();
        video.onclick = () => video.paused ? video.play() : video.pause();

        const progressBar = document.getElementById('progressBar');
        video.ontimeupdate = () => {
            const pct = (video.currentTime / video.duration) * 100;
            progressBar.style.width = `${pct}%`;
            document.getElementById('timeDisplay').innerText = 
                new Date(video.currentTime * 1000).toISOString().substr(11, 8) + " / " + 
                new Date(video.duration * 1000).toISOString().substr(11, 8);
        };

        document.getElementById('progressBarContainer').onclick = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
        };

        document.getElementById('fullscreenBtn').onclick = () => {
            !document.fullscreenElement ? video.parentNode.requestFullscreen() : document.exitFullscreen();
        };

        // Atalhos
        document.addEventListener('keydown', (e) => {
            if(e.target.tagName === 'INPUT') return;
            if(e.key === ' ' || e.key === 'k') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
            if(e.key === 'f') document.getElementById('fullscreenBtn').click();
            if(e.key === 'ArrowRight') video.currentTime += 5;
            if(e.key === 'ArrowLeft') video.currentTime -= 5;
        });

    </script>
</body>
</html>
