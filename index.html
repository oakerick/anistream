<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniStream Player | Catálogo e Superflix Integrados</title>
    
    <!-- Fontes e Ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- WebTorrent (Essencial para Magnet/Torrent) -->
    <script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js"></script>
    
    <style>
        /* =================================================================
           # ESTILOS GERAIS (TEMA DARK/STREAMING)
           ================================================================= */
        :root {
            --primary: #e50914;         /* Vermelho Netflix */
            --superflix: #9c27b0;       /* Roxo para a API */
            --bg-dark: #141414;         /* Fundo Principal */
            --bg-medium: #222;          /* Fundo de Painéis/Inputs */
            --border: #404040; 
            --text: #ffffff;
            --text-secondary: #b3b3b3;
            --player-max-width: 1300px;
            --player-height-ratio: 56.25%;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', Arial, sans-serif; outline: none; transition: all 0.2s ease-in-out; color: inherit; }
        body { background-color: #000; color: var(--text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* HEADER */
        header { padding: 15px 4%; background: var(--bg-dark); z-index: 20; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; border-bottom: 1px solid var(--border); }
        .logo { font-size: 2rem; font-weight: 900; color: var(--primary); letter-spacing: -1px; text-transform: uppercase; cursor: pointer; }
        .logo span { color: var(--text); font-weight: 300; }

        /* ABAS */
        .nav-menu { display: flex; gap: 20px; }
        .nav-item { background: none; border: none; color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; font-weight: 500; transition: color 0.2s; padding: 5px 0; }
        .nav-item:hover, .nav-item.active { color: var(--text); font-weight: 700; }
        .nav-item.active { border-bottom: 2px solid var(--primary); }

        /* LAYOUT PRINCIPAL */
        .main-layout { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px 4%; width: 100%; }
        .player-section { width: 100%; max-width: var(--player-max-width); margin-bottom: 30px; }
        #videoTitle { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .player-container { width: 100%; position: relative; padding-bottom: var(--player-height-ratio); height: 0; background: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border-radius: 4px; overflow: hidden; }
        .video-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #nativePlayer, #ytPlayer { width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: contain; }
        .video-wrapper.youtube-mode #nativePlayer { z-index: 0; }
        .video-wrapper.youtube-mode #ytPlayer { z-index: 6; }

        /* CONTROLES (Mantidos) */
        .custom-controls { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%); padding: 0 20px 15px 20px; opacity: 0; transition: opacity 0.3s; z-index: 10; }
        .video-wrapper:hover .custom-controls, .video-wrapper.paused .custom-controls { opacity: 1; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.3); margin-bottom: 10px; cursor: pointer; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 2px; position: relative; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; }
        .btn { background: none; border: none; color: #fff; cursor: pointer; padding: 5px; display: flex; }
        .btn:hover { transform: scale(1.1); }
        .material-icons { font-size: 1.8rem; }
        #volSlider { height: 5px; cursor: pointer; }

        /* INPUTS E CONTEÚDO */
        .content-panel { width: 100%; max-width: var(--player-max-width); }
        .input-group { display: none; flex-direction: column; gap: 15px; padding: 20px 0; }
        .input-group.active { display: flex; }
        
        /* BARRA DE PESQUISA LINK/MAGNET */
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box input { flex: 1; background: var(--bg-medium); border: 1px solid #444; color: white; padding: 12px 15px; font-size: 1rem; border-radius: 4px; }
        .search-box button, .action-btn { background: var(--primary); color: white; border: none; padding: 0 25px; font-weight: 700; font-size: 1rem; cursor: pointer; border-radius: 4px; text-transform: uppercase; }
        .search-box button:hover { background: #f40612; }

        /* GRID CATÁLOGO */
        .catalog-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
            margin-top: 20px;
        }
        .catalog-card { background: #222; border-radius: 4px; overflow: hidden; cursor: pointer; transition: transform 0.3s; position: relative; aspect-ratio: 2/3; }
        .catalog-card:hover { transform: scale(1.05); z-index: 5; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 2px solid var(--primary); }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 10px; }
        .card-title { font-size: 0.85rem; font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        
        /* BOTÃO SUPERFLIX */
        .superflix-btn { background: var(--superflix); color: white; width: 100%; padding: 15px; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .superflix-btn:hover { background: #7b1fa2; }
        .superflix-btn:disabled { background: #555; cursor: not-allowed; }

        /* LOADING & MODAL (Mantidos) */
        #torrentStatus { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 15; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-dark); padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; text-align: center; border: 1px solid var(--border); }
    </style>
</head>
<body>

    <header>
        <div class="logo">Ani<span>Stream</span></div>
        <div class="nav-menu">
            <button class="nav-item active" onclick="switchTab('catalog', this)">Início</button>
            <button class="nav-item" onclick="switchTab('url', this)">Link/Magnet</button>
            <button class="nav-item" onclick="switchTab('addon', this)">Configuração Proxy</button>
        </div>
        <div style="width: 32px; height: 32px; background: #333; border-radius: 4px;"></div>
    </header>

    <div class="main-layout">
        
        <!-- PLAYER -->
        <div class="player-section">
            <h2 id="videoTitle">Pronto para assistir</h2>
            <div class="player-container" id="videoContainer">
                <div class="video-wrapper paused" id="videoWrapper">
                    <video id="nativePlayer" playsinline></video>
                    <iframe id="ytPlayer" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>
                    
                    <!-- Overlay de Loading/Status -->
                    <div id="torrentStatus">
                        <div class="spinner"></div>
                        <div id="statusText" style="font-size: 1.2rem; font-weight: 600;">Carregando...</div>
                        <div id="statusDetail" style="color: #aaa; font-size: 0.9rem; margin-top: 5px;"></div>
                    </div>

                    <!-- Controles Personalizados -->
                    <div class="custom-controls">
                        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
                        <div class="controls-row">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button class="btn" id="playBtn" onclick="togglePlay()"><span class="material-icons">play_arrow</span></button>
                                <button class="btn" onclick="seekRelative(-10)"><span class="material-icons">replay_10</span></button>
                                <button class="btn" onclick="seekRelative(10)"><span class="material-icons">forward_10</span></button>
                                <button class="btn" id="muteBtn" onclick="toggleMute()"><span class="material-icons">volume_up</span></button>
                                <input type="range" id="volSlider" min="0" max="1" step="0.05" value="1" style="width: 80px;">
                                <span style="font-size: 0.8rem; margin-left: 10px;" id="timeDisplay">00:00:00 / 00:00:00</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button class="btn" onclick="toggleFullscreen()"><span class="material-icons">fullscreen</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEÇÃO DE CONTEÚDO (INPUTS/CATÁLOGO) -->
        <div class="content-panel">
            
            <!-- TAB 1: CATÁLOGO GERAL (Início) -->
            <div id="tab-catalog" class="input-group active">
                
                <h3 style="margin: 0 0 15px 0; color: var(--text-secondary); font-size: 1rem;">Destaques Locais (Demo)</h3>
                <div class="catalog-grid" id="catalogGrid"></div>
                
                <!-- BOTÃO PARA CARREGAR SUPERFLIX (Desabilitado até o Proxy ser configurado) -->
                <button class="superflix-btn" onclick="loadSuperflixCatalog()" id="loadSuperflixBtn" disabled>
                    <span class="material-icons">lock</span> Configure o Proxy para carregar Animes Populares
                </button>
                
                <!-- RESULTADOS DA SUPERFLIX APARECERÃO AQUI -->
                <div id="superflixSection" style="margin-top: 30px; display: none;">
                    <h3 style="color:var(--text); margin-bottom:15px; font-weight:700;">Catálogo Superflix (Animes TMDB)</h3>
                    <div class="catalog-grid" id="superflixGrid"></div>
                </div>
            </div>

            <!-- TAB 2: LINK/MAGNET & LOCAL FILES -->
            <div id="tab-url" class="input-group">
                <h3 style="margin: 0;">Carregar Mídia Externa</h3>
                <div class="search-box">
                    <input type="text" id="directLink" placeholder="Cole Link Magnet, YouTube ou URL MP4...">
                    <button onclick="loadFromInput()">Reproduzir</button>
                </div>
                
                <div class="file-drop-zone" style="border: 2px dashed #444; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                    <span class="material-icons" style="font-size: 3rem; display: block; margin-bottom: 10px;">cloud_upload</span> 
                    Ou clique para carregar Arquivo Local (.mp4, .torrent)
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(this.files)">
                </div>
            </div>

            <!-- TAB 3: CONFIGURAÇÃO PROXY -->
            <div id="tab-addon" class="input-group">
                <h3 style="margin: 0;">Configuração de Proxy e API</h3>
                
                <div style="background: var(--bg-medium); padding: 15px; border-radius: 4px;">
                    <p style="margin: 0 0 10px 0; color: var(--text-secondary); font-size: 0.9rem;">URL do Proxy Vercel (Obrigatório para evitar CORS):</p>
                    <div class="search-box">
                        <input type="text" id="addonUrl" placeholder="Ex: https://seu-proxy.vercel.app">
                        <button onclick="saveAddonUrl()">Salvar</button>
                    </div>
                    <p style="color:var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">Esta URL é usada para buscar o catálogo Superflix (aba Início) e Streams do Addon Stremio.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 id="modalTitle">Aviso</h3>
            <p id="modalMsg" style="color: #ccc; margin: 15px 0;">Mensagem...</p>
            <button class="action-btn" onclick="document.getElementById('modal').style.display='none'" style="width: 100%;">OK</button>
        </div>
    </div>

    <script>
        /* =================================================================
           # LÓGICA JAVASCRIPT (PLAYER, WEBTORRENT E API)
           ================================================================= */
        
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const client = new WebTorrent();
        let addonBaseUrl = localStorage.getItem('addonUrl') || '';
        
        // DOM Elements
        const nativeVideo = document.getElementById('nativePlayer');
        const ytIframe = document.getElementById('ytPlayer');
        const wrapper = document.getElementById('videoWrapper');
        const titleEl = document.getElementById('videoTitle');
        const statusEl = document.getElementById('torrentStatus');
        const statusText = document.getElementById('statusText');
        const statusDetail = document.getElementById('statusDetail');
        const playBtn = document.getElementById('playBtn');
        const muteBtn = document.getElementById('muteBtn');
        const progressBar = document.getElementById('progressBar');
        const volumeSlider = document.getElementById('volSlider');

        // Catálogo Local de Demonstração
        function getLocalCatalog() {
            return [
                { title: "Big Buck Bunny", type: "Demo MP4", img: "https://upload.wikimedia.org/wikipedia/commons/c/c5/Big_buck_bunny_poster_big.jpg", link: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4", isMagnet: false },
                { title: "Sintel (Torrent)", type: "Demo Magnet", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Sintel_poster.jpg/320px-Sintel_poster.jpg", link: "magnet:?xt=urn:btih:08ada5a7a6183aae1e09d831df6748d566095a10&dn=Sintel", isMagnet: true }
            ];
        }

        // --- INICIALIZAÇÃO E EVENTOS ---
        window.onload = () => {
            if (addonBaseUrl) document.getElementById('addonUrl').value = addonBaseUrl;
            renderCatalog(getLocalCatalog(), 'catalogGrid');
            setupPlayerEvents();
            checkProxyUrlAndEnableButton(); // NOVO: Verifica e configura o botão ao carregar
        };

        // --- NAVEGAÇÃO ---
        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.input-group').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            btn.classList.add('active');
        };
        
        // --- PLAYER CORE & CONTROLES ---
        
        function updateTimeDisplay() {
            const formatTime = (seconds) => {
                if (isNaN(seconds) || seconds < 0) return '00:00:00';
                return new Date(seconds * 1000).toISOString().substr(11, 8);
            };
            const current = formatTime(nativeVideo.currentTime);
            const duration = formatTime(nativeVideo.duration);
            document.getElementById('timeDisplay').innerText = `${current} / ${duration}`;
            
            const pct = (nativeVideo.currentTime / nativeVideo.duration) * 100;
            document.getElementById('progressFill').style.width = pct + '%';
        }

        function loadMedia(source, title, type) {
            titleEl.innerText = title;
            statusEl.style.display = 'none';
            wrapper.classList.remove('youtube-mode');
            ytIframe.src = '';
            
            // Limpa torrents anteriores
            if (client.torrents.length > 0) client.torrents.forEach(t => t.destroy());

            if (type === 'youtube') {
                wrapper.classList.add('youtube-mode');
                nativeVideo.pause();
                nativeVideo.style.zIndex = 0; 
                ytIframe.style.zIndex = 6;
                ytIframe.src = `https://www.youtube.com/embed/${source}?autoplay=1&rel=0`;
            } 
            else if (type === 'magnet' || type === 'file') {
                nativeVideo.style.zIndex = 5; 
                ytIframe.style.zIndex = 0;
                
                statusEl.style.display = 'flex';
                statusText.innerText = "Conectando aos peers...";

                client.add(source, torrent => {
                    const file = torrent.files.find(f => f.name.match(/\.(mp4|mkv|webm)$/i));
                    
                    torrent.on('download', () => {
                        statusDetail.innerText = `Baixado: ${(torrent.downloaded/1024/1024).toFixed(1)}MB | Vel: ${(torrent.downloadSpeed/1024/1024).toFixed(2)}MB/s | Peers: ${torrent.numPeers}`;
                    });

                    if(file) {
                        file.renderTo(nativeVideo, { autoplay: true }, (err) => {
                            if(err) showAlert("Erro WebTorrent", err.message);
                            statusEl.style.display = 'none';
                            updatePlayIcon(true);
                        });
                    } else {
                        showAlert("Erro", "Nenhum arquivo de vídeo compatível encontrado no torrent.");
                        statusEl.style.display = 'none';
                    }
                });
            } 
            else {
                nativeVideo.style.zIndex = 5; 
                ytIframe.style.zIndex = 0;
                nativeVideo.src = source;
                nativeVideo.play().then(() => updatePlayIcon(true)).catch(() => {
                    nativeVideo.muted = true;
                    nativeVideo.play();
                    updatePlayIcon(true);
                });
            }
        }

        function setupPlayerEvents() {
            nativeVideo.addEventListener('play', () => { updatePlayIcon(true); wrapper.classList.remove('paused'); });
            nativeVideo.addEventListener('pause', () => { updatePlayIcon(false); wrapper.classList.add('paused'); });
            nativeVideo.addEventListener('timeupdate', updateTimeDisplay);
            nativeVideo.addEventListener('loadedmetadata', updateTimeDisplay);

            volumeSlider.oninput = (e) => setVolume(parseFloat(e.target.value));
            
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                seekTo(pos * nativeVideo.duration);
            });
            
            // Atalhos de teclado
            document.addEventListener('keydown', (e) => {
                const isInputFocused = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
                if (isInputFocused) return;
                
                switch (e.key.toLowerCase()) {
                    case ' ': case 'k': e.preventDefault(); togglePlay(); break;
                    case 'j': e.preventDefault(); seekRelative(-10); break;
                    case 'l': e.preventDefault(); seekRelative(10); break;
                    case 'm': e.preventDefault(); toggleMute(); break;
                    case 'f': e.preventDefault(); toggleFullscreen(); break;
                    case 'arrowup': e.preventDefault(); const newVolUp = Math.min(1, nativeVideo.volume + 0.05); setVolume(newVolUp); break;
                    case 'arrowdown': e.preventDefault(); const newVolDown = Math.max(0, nativeVideo.volume - 0.05); setVolume(newVolDown); break;
                    case 'arrowleft': e.preventDefault(); seekRelative(-5); break;
                    case 'arrowright': e.preventDefault(); seekRelative(5); break;
                    default: if (e.key >= '0' && e.key <= '9') { e.preventDefault(); const time = (nativeVideo.duration / 10) * parseInt(e.key); seekTo(time); } break;
                }
            });
        }
        
        window.togglePlay = () => nativeVideo.paused ? nativeVideo.play() : nativeVideo.pause();
        
        window.seekTo = (time) => nativeVideo.currentTime = time;
        window.seekRelative = (val) => nativeVideo.currentTime += val;
        
        window.setVolume = (vol) => {
            nativeVideo.volume = vol;
            volumeSlider.value = vol;
            nativeVideo.muted = (vol === 0);
            muteBtn.innerHTML = nativeVideo.muted ? '<span class="material-icons">volume_off</span>' : '<span class="material-icons">volume_up</span>';
        };

        window.toggleMute = () => {
            const newMuteState = !nativeVideo.muted;
            if (newMuteState) {
                // Mudo
                nativeVideo.muted = true;
                muteBtn.innerHTML = '<span class="material-icons">volume_off</span>';
                volumeSlider.value = 0;
            } else {
                // Desmudo (retorna ao último volume, ou 1 se estiver zerado)
                nativeVideo.muted = false;
                const currentVol = parseFloat(volumeSlider.value);
                if (currentVol === 0) {
                    volumeSlider.value = 1;
                    nativeVideo.volume = 1;
                }
                muteBtn.innerHTML = '<span class="material-icons">volume_up</span>';
            }
        };

        window.toggleFullscreen = () => {
            if(!document.fullscreenElement) document.getElementById('videoContainer').requestFullscreen();
            else document.exitFullscreen();
        };

        function updatePlayIcon(isPlaying) {
            playBtn.innerHTML = isPlaying ? '<span class="material-icons">pause</span>' : '<span class="material-icons">play_arrow</span>';
        }

        function showAlert(title, msg) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMsg').innerText = msg;
            document.getElementById('modal').style.display = 'flex';
        }

        // --- FUNÇÕES DE INPUT ---

        window.loadFromInput = () => {
            const val = document.getElementById('directLink').value.trim();
            if(!val) return;
            
            if(val.startsWith('magnet:')) loadMedia(val, "Stream Magnet", 'magnet');
            else if(val.includes('youtube.com') || val.includes('youtu.be')) {
                const id = val.match(/(?:v=|\/)([\w-]{11})/)?.[1];
                if(id) loadMedia(id, "YouTube Video", 'youtube');
            } else {
                loadMedia(val, "Stream Direto", 'url');
            }
        }

        window.handleFileSelect = (files) => {
            if(!files.length) return;
            const file = files[0];
            if(file.name.endsWith('.torrent')) {
                loadMedia(file, file.name.replace('.torrent',''), 'magnet'); 
            } else if (file.type.startsWith('video/')) {
                loadMedia(URL.createObjectURL(file), file.name, 'url');
            } else {
                showAlert("Formato Inválido", "Selecione um arquivo .torrent ou de vídeo.");
            }
        }
        
        // --- FUNÇÕES DE CATALOGO/RENDERIZAÇÃO ---
        
        function renderCatalog(items, targetId, clickHandler) {
            const grid = document.getElementById(targetId);
            grid.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'catalog-card';
                card.innerHTML = `
                    <img src="${item.img || 'https://placehold.co/320x480/181818/b3b3b3?text=N/A'}" class="card-img" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/320x480/181818/b3b3b3?text=N/A'">
                    <div class="card-overlay"><div class="card-title">${item.title}</div></div>
                `;
                card.onclick = () => {
                    if (clickHandler) {
                        clickHandler(item);
                    } else {
                        // Comportamento padrão para catálogo local
                        loadMedia(item.link, item.title, item.isMagnet ? 'magnet' : 'url');
                    }
                };
                grid.appendChild(card);
            });
        }

        // --- FUNÇÕES DE ADDON/API ---
        
        function checkProxyUrlAndEnableButton() {
            const btn = document.getElementById('loadSuperflixBtn');
            // Verifica se a URL salva é um endereço HTTP válido (não apenas vazio)
            if (addonBaseUrl && addonBaseUrl.startsWith('http')) {
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons">movie_filter</span> Carregar Animes Populares (Superflix API)';
            } else {
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons">lock</span> Configure o Proxy para carregar Animes Populares';
            }
        }


        window.saveAddonUrl = () => {
            const url = document.getElementById('addonUrl').value.trim().replace(/\/$/, '');
            if(!url.startsWith('http')) return showAlert("Erro", "URL inválida. Use o formato https://...");
            
            localStorage.setItem('addonUrl', url);
            addonBaseUrl = url;
            checkProxyUrlAndEnableButton(); // NOVO: Atualiza o botão após salvar
            showAlert("Sucesso", "URL do Proxy Vercel salva! Agora você pode carregar o catálogo na aba 'Início'.");
        };

        // Função de integração Superflix (agora chamada da aba Início)
        window.loadSuperflixCatalog = async () => {
            if(!addonBaseUrl || !addonBaseUrl.startsWith('http')) {
                return showAlert("Configuração Necessária", "A URL do Proxy Vercel não está configurada ou é inválida. Por favor, vá para a aba 'Configuração Proxy'.");
            }
            
            const btn = document.getElementById('loadSuperflixBtn');
            // Mantém o botão escondido se já foi carregado. Se estiver visível, desabilita e mostra loading.
            if(btn.style.display !== 'none') {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; margin: 0;"></span> Carregando...';
            }
            
            statusEl.style.display = 'flex';
            statusText.innerText = "Buscando Animes...";
            statusDetail.innerText = `Consultando Proxy em: ${addonBaseUrl}/superflix`;

            try {
                // Adicionado console.log para ajudar a depurar a URL exata
                console.log(`Tentando buscar catálogo em: ${addonBaseUrl}/superflix`);
                const response = await fetch(`${addonBaseUrl}/superflix`);
                
                if(!response.ok) {
                    console.error("HTTP Error:", response.status, response.statusText);
                    throw new Error(`Erro HTTP ${response.status} ao conectar ao Proxy.`);
                }
                
                const data = await response.json();
                
                const items = Array.isArray(data) ? data : (data.results || data.list || []);
                
                if(items.length === 0) throw new Error("Nenhum anime encontrado na resposta da API.");

                // Renderiza na nova seção dedicada
                document.getElementById('superflixSection').style.display = 'block';
                document.querySelector('#superflixSection h3').innerText = `Catálogo Superflix (Animes TMDB - ${items.length} resultados)`;
                
                renderCatalog(items.map(item => ({
                    title: item.title || item.name || "Sem Título",
                    img: item.poster_path ? `https://image.tmdb.org/t/p/w300${item.poster_path}` : (item.image || ''),
                    id: item.id // Guarda o ID do TMDB
                })), 'superflixGrid', (item) => searchStreams(item.id, item.title));

                statusEl.style.display = 'none';
                btn.style.display = 'none'; // Esconde o botão após carregar com sucesso
                window.scrollTo({top:0, behavior:'smooth'});

            } catch (e) {
                console.error("Erro no carregamento do catálogo:", e);
                statusEl.style.display = 'none';
                
                // Em caso de erro, re-habilita o botão para nova tentativa
                if(btn.style.display !== 'none') {
                   btn.disabled = false;
                   btn.innerHTML = '<span class="material-icons">refresh</span> Tentar Carregar Novamente (Superflix API)';
                }

                showAlert("Erro API", "Falha ao carregar catálogo. Verifique se a URL do Proxy Vercel está correta e funcionando na aba 'Configuração Proxy'. Detalhes: " + e.message);
            }
        };

        // Função para buscar streams (Magnets/URLs) usando o ID do TMDB
        async function searchStreams(id, title) {
            if(!addonBaseUrl || !addonBaseUrl.startsWith('http')) {
                return showAlert("Configuração Necessária", "A URL do Proxy Vercel não está configurada ou é inválida. Por favor, vá para a aba 'Configuração Proxy'.");
            }

            statusEl.style.display = 'flex';
            statusText.innerText = `Buscando streams para: ${title}`;
            statusDetail.innerText = "Consultando Addon Stremio via Proxy...";
            
            const type = 'movie'; // Assumindo 'movie' para o TMDB ID no addon Stremio
            const url = `${addonBaseUrl}/streams/${type}/${id}.json`; 
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                statusEl.style.display = 'none';
                
                if(!data.streams || !data.streams.length) return showAlert("Info", `Nenhum stream encontrado para ${title}.`);
                
                const stream = data.streams.find(s => s.url || s.infoHash);
                
                if (stream) {
                    const link = stream.url || stream.infoHash;
                    const streamType = link.startsWith('http') ? 'url' : 'magnet';
                    loadMedia(link, title, streamType);
                    window.scrollTo({top:0, behavior:'smooth'});
                } else {
                    showAlert("Info", "Nenhum link de stream válido encontrado.");
                }

            } catch(e) {
                statusEl.style.display = 'none';
                showAlert("Erro Stream", "Falha ao buscar streams no addon: " + e.message);
            }
        }
    </script>
</body>
</html>
